---
title: "DFO Reference Points 101"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
knitr::opts_chunk$set(echo = T, warnings= F)
```

## Exercise 1: Reference points using a Schaefer Surplus Production Model. 

A time series of catch (1950-2005) and survey index (1963-1970 and 1975-2005) are provided for a swordfish stock in dataframe **DF**. 

The Schaefer model is: *B*~*t*+1~ = *B*~*t*~ + *rB*~*t*~ (1-*B*~*t*~/*K*) - *C*~*t*~

where *B* is biomass, *r* is the intrinsic rate of population growth, *K* is the carrying capacity, *C* is the catch, and *t* is a discrete time period. *B*~MSY~ is estimated as *K*/2 and *u*~MSY~ is estimated *r*/2.

```{r, echo=F,warning=F,figures-side, fig.show="hold", out.width="50%"}
DF <- read.csv("swordfish.csv")
ggplot(DF) + geom_path(mapping=aes(y=Catch,x=Year)) + theme_classic() +
  scale_x_continuous(limits = c(1950,2005), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,22000), expand = c(0, 0)) 
ggplot(DF) + geom_path(mapping=aes(y=Index,x=Year), colour="blue") + theme_classic() +
  scale_x_continuous(limits = c(1950,2005), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,1200), expand = c(0, 0)) 
```

```{r}
DF <- read.csv("swordfish.csv")
tail(DF)
```

Exercise Questions

1. Estimate *B*~MSY~, MSY, and *u*~MSY~ (*u* is used as the harvest rate instead of *F* = instantaneous fishing mortality rate) from the model estimated parameter values (*r* and *K*). Plot the model estimated biomass time series. The Schaefer model can be fit using various software packages. Here we use the SAMtool R package where a data object is created and the Catch, Index, Years, and coefficient of variation for the Index (CV_Ind: needed for model fitting but does not influence model parameter estimates) and used for model fitting.


```{r,warning=F,message=F}
library(SAMtool)

D <- new('Data')
D@Name <- "swordfish"
D@Cat <- matrix(DF$Catch,nrow=1)
D@Year <- 1950:2005
D@Ind <- matrix(DF$Index,nrow=1)
D@CV_Ind <- matrix(0.3, nrow=1, ncol=length(D@Year))

Model <- SP(Data = D)

K <- Model@TMB_report$K
r <- Model@TMB_report$r

DF$Model_biomass <- Model@B[1:length(D@Year)]
```

2. Project the stock forward 100 years using *u* = 0 and *u*~MSY~. Plot the projected biomass over time and show that the long-term equilibrium biomass values from fishing at *u* = 0 and *u*~MSY~ are *K* and *K*/2 = *B*~MSY~ estimated from Question 1. The code below will help with the projections (stored in array **P**).

```{r,warning=F}
u <- c(0,r/2)
P <- array(NA,dim=c(length(u),100,2),dimnames = list(u,1:100,c("Biomass","Catch")))

terminalB <- DF$Model_biomass[DF$Year==2005]
terminalC <- DF$Catch[DF$Year==2005]

for(i in 1:length(u)){ #loop over u
  for(y in 1:100){     #loop over years
    if(y==1){          #get terminal year (2005) catch and biomass to begin projections for year 1
      lastB <- terminalB
      lastC <- terminalC
    } else {
      lastB <- P[i,(y-1),1]
      lastC <- P[i,(y-1),2]
    }
    P[i,y,1] <- lastB + r*lastB*(1-lastB/K)-lastC # Estimated Biomass from the Schaefer model
    P[i,y,2] <- P[i,y,1]*u[i] # Estimated Catch from the Schaefer model
  }
}
```

3. Project the stock forward 100 years using *u* as a vector from 0 to 1 in steps of 0.001 by modifying the code from Question 2. Plot the long-term equilibrium yield (i.e., Catch) versus *u* and show that the *u* that maximizes yield is the estimate of *u*~MSY~ from Question 1.


Solutions:

Question 1

```{r,warning=F}
Bmsy <- K/2
Bmsy
umsy <- r/2
umsy
MSY <- Bmsy*umsy
MSY

ggplot() + geom_path(data=DF,mapping=aes(y=Model_biomass,x=Year)) + theme_classic()  +
  scale_x_continuous(limits = c(1950,2005), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,120000), expand = c(0, 0))

```

Question 2

```{r,warning=F}
# u = 0
DFu0 <- data.frame(Model_biomass=P[1,,1],Year=2006:(2006+99))
ggplot() + geom_path(data=DF,mapping=aes(y=Model_biomass,x=Year)) + theme_classic()  +
  scale_x_continuous(limits = c(1950,(2005+100)), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,120000), expand = c(0, 0)) +
  geom_path(data=DFu0,mapping=aes(y=Model_biomass,x=Year),colour="blue")

# u = umsy
DFumsy <- data.frame(Model_biomass=P[2,,1],Year=2006:(2006+99))
ggplot() + geom_path(data=DF,mapping=aes(y=Model_biomass,x=Year)) + theme_classic()  +
  scale_x_continuous(limits = c(1950,(2005+100)), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,120000), expand = c(0, 0)) +
  geom_path(data=DFumsy,mapping=aes(y=Model_biomass,x=Year),colour="orange")

# used last 50 years for equilibrium 
# u = 0 and u = msy
projected_equilbrium_B <- apply(P[,51:100,1],1,mean)
projected_equilbrium_B
```

Question 3

```{r,warning=F}
u <- seq(0,1,0.001)
P <- array(NA,dim=c(length(u),100,2),dimnames = list(u,1:100,c("Biomass","Catch")))

terminalB <- DF$Model_biomass[DF$Year==2005]
terminalC <- DF$Catch[DF$Year==2005]

for(i in 1:length(u)){
  for(y in 1:100){
    if(y==1){
      lastB <- terminalB
      lastC <- terminalC
    } else {
      lastB <- P[i,(y-1),1]
      lastC <- P[i,(y-1),2]
    }
    P[i,y,1] <- lastB + r*lastB*(1-lastB/K)-lastC
    P[i,y,2] <- P[i,y,1]*u[i]
  }
}

# used last 50 years for equilibrium 
EX3 <- data.frame(u=u,Yield = apply(P[,51:100,2],1,mean),equil_B = apply(P[,51:100,1],1,mean))
ggplot(EX3)+geom_path(mapping=aes(y=Yield ,x=u)) + theme_classic() +
  scale_x_continuous(limits = c(0,1), expand = c(0,0)) +
  scale_y_continuous(limits = c(0,20000), expand = c(0,0)) +
  # add vertical line at umsy estimated from model parameter r
  geom_vline(xintercept = r/2, linetype = 1, colour = "blue") 
```