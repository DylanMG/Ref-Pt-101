---
title: "DFO Reference Points 101 (Revised draft)"
output: html_document
author: "Tim Barrett and Robyn Forrest"
date: "November 2022"
---

```{r setup, include=FALSE}
library(tidyverse)
library(reshape2)
source("source_ftns.r")
knitr::opts_chunk$set(echo = T, warnings= F)
```

## Exercise 2: Estimating unfished biomass and MSY reference points using an age-structured model with a Beverton-Holt stock-recruit relationship

***DISCLAIMER: These are illustrative, deterministic models and should not be used for stock assessment***

**Run the R chunks in Rstudio using the green arrow in each chunk. Run individual lines in the chunks using ctrl+enter. If you want to explore further, you can add your own R code inside any of the chunks, or add your own chunks using ctrl+alt+i. Click on the Knit button in Rstudio to create the document.**

Here, we will extend the ideas from Exercise 1 to an age-structured model. By the end of the exercise you will learn how to:

* Calculate equilibrium unfished biomass (*B*~0~) and equilibrium MSY reference points (*B*~MSY~, *F*~MSY~, *MSY*) when a stock-recruitment relationship is assumed

* ...

We will use outputs based on an operating model from [openMSE](https://openmse.com/) that has been conditioned on age-composition data, catch and a survey index for an Atlantic cod stock for ages 4+.

We assume a Beverton-Holt stock-recruit relationship (Beverton and Holt 1957; Hilborn and Walters 1992, Ch 7). The stock-recruit pairs are plotted below and saved in the dataframe **SR**. The biological data (weight-at-age, maturity-at-age, *M*-at-age) and assumed selectivity-at-age are saved in the dataframe **BI**.

<!-- NOTE TO TIM: I overwrote BI$sel with values from a logistic curve. See get-sel-pars.R. You shouldn't need to run it as I overwrote the Ex2 rda file but have saved the original -->

```{r,warning=F, fig.show="hold", out.width="75%"}
data <- readRDS("Ex2data.rda")
# Dataframe SR with Year, SSB in kt, and age 0 recruitment in millions
SR <- data$SR
# Dataframe BI with ages (0 to 12+), weight-at-age in kg (waa), proportion mature-at-age (mat), M-at-age, selectivity-at-age (sel)
BI <- data$BI

# Beverton-Holt parameters a and b (model estimated and used for plotting and reference point calculations)
BHa <- data$BHa
BHb <- data$BHb

# Preview data
head(SR)
head(BI)

# Plot the stock-recruitment relationship
P <- ggplot(SR) + geom_point(mapping=aes(y=Rec,x=SSB,colour=Year)) + theme_classic() + 
  labs(x="SSB (kt)",y="Age 0 Recruits (millions)") +
  scale_x_continuous(limits = c(0,80), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,40), expand = c(0, 0)) +
  geom_function(fun=function(x) (BHa*x / (1+BHb*x)),colour="black",linetype=1)+
  theme(axis.text.x = element_text(size=12))+
  theme(axis.text.y = element_text(size=12))+
  theme(axis.title.x = element_text(size=12, face="bold"))+
  theme(axis.title.y = element_text(size=12, face="bold"))
P
```

Age-structured models keep track of the number of fish that are alive at a given age and time (determined by recruitment, natural mortality and fishing mortality), the proportion mature at a given age (determined by the maturity-at-age schedule), as well as the proportion of fish that are vulnerable (or "available") to the fishery (determined by the vulnerability-at-age schedule). For this exercise, we assume these schedules are fixed in time. 

```{r,warning=F, fig.show="hold", out.width="75%"}

# Plot maturity-at-age and selectivity-at age
matsel <- BI %>% 
  select(age,mat,sel) %>%
  melt(id="age", variable.name="Schedule",value.name="Proportion") %>%
  # Rename labels mat, sel and age for prettier plotting
  mutate(Schedule=as.character(Schedule)) %>% 
  mutate(Schedule = replace(Schedule, Schedule=="mat","Maturity"),
         Schedule = replace(Schedule, Schedule=="sel","Vulnerability")) %>% 
  rename("Age"=age) %>%
  ggplot() + 
  geom_line(mapping=aes(x=Age,y=Proportion,colour=Schedule), size=1.5) + 
  theme_classic() + 
  theme(axis.text.x = element_text(size=12))+
  theme(axis.text.y = element_text(size=12))+
  theme(axis.title.x = element_text(size=12, face="bold"))+
  theme(axis.title.y = element_text(size=12, face="bold"))+
  theme(legend.title = element_text(size=12, face="bold"))+
  theme(legend.title = element_text(size=12))+
  scale_x_continuous(limits = c(0,12), breaks = 0:12, expand = c(0, 0)) 
matsel


```

In this plot, we can see that the vulnerability curve is to the right of the maturity curve, implying that fish mature and have a chance to spawn before they are vulnerable to the fishery. 

Note that the terms vulnerability and selectivity are used somewhat interchangeably in fisheries. The term vulnerability captures both the "availability" of fish to the gear  (which could be determined by the location of the fishery relative to demographic components of the population, e.g., patterns in depth distribution) and "selectivity" of the fishing gear (e.g., mesh size, hook size or escape panels). However, the term selectivity is in common use as an interchangeable term with vulnerability. In these exercises, we will try to use the term vulnerability to be consistent with the equations but will sometimes use the term selectivity.

## Equilibrium calculations

Now we look at the equilibrium calculations used to calculate reference points, given a set of model parameters. These exercises use deterministic parameter values but please be aware that stock assessments estimate parameters with uncertainty and that this uncertainty carries through into the reference points.

### Unfished per recruit calculations

As for the simpler surplus production model in the previous exercise, the equilibrium unfished biomass is the biomass that would result from running out the population model for a long period without fishing under constant average conditions. Usually reference points  are based on spawning biomass (SSB), as this is the component of the population of most conservation interest.

<!-- NOTE TO TIM: I changed s_a to l_a, in keeping with most literature I use (including Walters and Martell 2004). s_a is most commonly used to represent survival rate e^-Z -->

However, we can calculate equilibrium model behaviour more efficiently than running out models for many years, using equilibrium "per-recruit" methods, or "incidence functions" (see Walters and Martell 2004, Box 3.1). The equations are similar to those used in the time-dynamic population model, but are based on the idea of survivorship-at-age (*l~a~*), which tracks the proportion of recruits that survive from age to age. In the absence of fishing, equilibrium survivorship is given by

\begin{equation*}
\tag{1}
  l_{a} = \left\{ 
  \begin{matrix}
    1 & , & a = a_{rec} \\ 
    l_{a-1}e^{-(M_{a-1})} & , & 1 < a_{rec} < a_{max} \\ 
    \frac{l_{a-1}e^{-(M_{a-1}}}{1-e^{-(M_{a})}} & , & a = a_{max}
  \end{matrix}
  \right\}
\end{equation*}

where $a$ = age, $a_{rec}$ = age-at-recruitment, $a_{max}$ = maximum age (plus group), $M_{a}$ = natural mortality rate-at-age and $l_{a}$is 1, by definition, at $a_{rec}$.

The equilibrium unfished SSB per recruit ($\phi$~E0~) can then be calculated as the sum-product of the equilibrium survivorship-at-age ($l_{a}$), the weight-at-age ($w_{a}$), and the maturity-at-age ($m_{a}$):

\begin{equation}
\tag{2}
{\phi_{E0}} = \sum_{a=a_{rec}}^{a_{max}} l_{a}w_{a}m_{a}
\end{equation}

where we use the subscript *E* because we assume that SSB is a proxy for eggs produced. We then obtain an estimate of the equilibrium unfished SSB (SSB~0~) from $\phi_{E0}$ and an estimate of unfished recruitment $R_{0}$, i.e., 

\begin{equation}
\tag{3}
{SSB_0} = {R_0}{\phi_{E0}}
\end{equation}

### Per recruit calculations with fishing

In order to calculate MSY-based reference points, we also need to calculate long-term equilibrium population behaviour under constant fishing mortality rates.

At any constant equilibrium fishing mortality $F_{e}$, the equilibrium survivorship-at-age $\hat{l_a}$ is a simple modification of Equation 1, accounting for fishing mortality and vulnerability-at-age $v_{a}$:

\begin{equation*}
\tag{4}
  \hat{l}_{a} = \left\{ 
  \begin{matrix}
    1 & , & a = a_{rec} \\ 
    \hat{l}_{a-1}e^{-(M_{a-1}+F_{e}v_{a-1})} & , & 1 < a_{rec} < a_{max} \\ 
    \frac{\hat{l}_{a-1}e^{-(M_{a-1}+F_{e}v_{a-1})}}{1-e^{-(M_{a}+F_{e}v_{a})}} & , & a = a_{max}
  \end{matrix}
  \right\}
\end{equation*}

SSB-per-recruit ($\phi_{Ef}$) is then given by

\begin{equation}
\tag{5}
{\phi_{Ef}} = \sum_{a=a_{rec}}^{a_{max}} \hat{l}_{a}w_{a}m_{a}
\end{equation}

*Note:* The `survivorship_F()` function in source_ftns.R can be used here to calculate $\hat{l_a}$ for any *F~e~* as shown in Equation 5. To obtain unfished $l_{a}$, set f=0.

We can also calculate the unfished vulnerable biomass per recruit $\phi_{VB}$:

\begin{equation}
\tag{6}
{\phi_{VB}} = \sum_{a=a_{rec}}^{a_{max}} \hat{l}_{a}w_{a}v_{a}
\end{equation}

We saw in Equation 3 that we could estimate $SSB_{0}$ from an estimate of $R_{0}$ and  $\phi_{E0}$. To estimate $SSB_{MSY}$ (i.e., $B_{MSY}$), we need an estimate of recruitment at $F_{MSY}$ (we will see where $F_{MSY}$ comes from later).

*~~~~~~ RF is up to here and will finish updating this exercise. There is a much simpler way to solve for BMSY ~~~~~~~*

The Beverton-Holt stock-recruitment relationship equation is the ratio of the equilibrium SSB and equilibrium recruitment at *F* = 0 *this is a very odd statement* 
\begin{equation*}
\tag{3}
  R = \frac{aSSB}{1+bSSB}
\end{equation*} 

*Let's just assume we are estimating R0*

The stock-recruitment relationship evaluated at *SSB*~0~ gives the equilibrium unfished recruitment 
\begin{equation*}
\tag{5}
{R_0} = \frac{aSSB_0}{1+bSSB_0} 
\end{equation*} 

*We don't really need this. We assume the model estimates R0, then we can get SSB0 from eq 3. If we have estimated steepness and R0, then we also already have bha and bhb*

$\phi_{0}$ is estimated from *M* and the biological data, and the $a$ and $b$ stock-recruitment parameters are estimated by the model. With two equations (Equations 4 and 5) and two unknowns (*SSB*~0~, and *R*~0~) we can solve for *SSB*~0~ by rearranging Equation 4 to be ${R_0}$ = $\frac{SSB_0}{\phi_0}$ and setting equal to Equation 5: 

\begin{equation*}
\tag{6}
\frac{SSB_0}{\phi_0} = \frac{aSSB_0}{1+bSSB_0}
\end{equation*} 

Diving both sides by *SSB*~0~ and rearranging results in 
\begin{equation*}
\tag{7}
SSB_0 = \frac{a\phi_0-1}{b} 
\end{equation*} 

```{r,message=F}
surv0 <- survivorship_F(f=0,M=BI$M,n_ages=nrow(BI)) # This is Equation 2 at F = 0
phi0 <- sum(surv0*BI$waa*BI$mat) # This is Equation 1 at F = 0
phi0

SSB0 <- (BHa*phi0-1)/BHb # This is Equation 7
SSB0
```

The estimation of *SSB*~0~ can be shown visually as the SSB at the intersection of the SRR and a line through the origin with slope equal to the inverse of $\phi$~0~ (i.e., unfished recruits per spawner). This is illustrated below:


```{r,out.width="75%"}
P + geom_function(fun=function(x) (1/phi0*x),colour="red",linetype=2) +
    geom_vline(xintercept=SSB0, linetype=2, color = "red") 
```

## Estimate the MSY reference points (*F*~MSY~, *SSB*~MSY~, MSY)

The `MSY_calc()` function in source_ftns.R can be used to estimate *F*~MSY~, *SSB*~MSY~, and *MSY*. The calculations in this function are shown below and follow these steps:

a) Define a vector for *F* `f <- seq(0,5,0.001)`
b) For each *F*, calculate the SSB-per-recruit ($\phi_F$) and the yield-per-recruit ($YPR_F$)
c) For each *F*, calculate $yield$ as the product of $YPR_F$ the the equilibrium recruitment at *F*.

$YPR_F$ is calculated as [e.g., see page XX of Martell and Walters (2004)]:

\begin{equation}
\tag{8}
{YPR_F} = \sum_{a=a_{rec}}^{a_{max}} s_{a}w_{a}(1-e^{-(M_a+Fv_a)})\frac{Fv_a}{M_a+Fv_a}
\end{equation}

The the equilibrium recruitment at *F* is calculated by first calculating the equilibrium SSB at each *F* (similar to Equation 7):

\begin{equation*}
\tag{9}
SSB_F = \frac{a\phi_F-1}{b} 
\end{equation*}

and substituting the equilibrium SSB at each *F* into the stock-recruitment relationship (Equation 3)

d) Calculate *F*~MSY~ as the *F* that maximizes yield
e) Calculate *SSB*~MSY~ as the equilibrium SSB at *F*~MSY~
f) Calculate *MSY* as the yield at *F*~MSY~


```{r,message=F}
# a)
f <- seq(0,5,0.001) #Fishing mortality rate

# Define a dataframe (DF) with columns for f, SSB-per-recruit (phi), yield-per-recruit, equilibrium SSB, equilibrium recruitment, and yield
DF <- data.frame(f=f, phi_f=NA, ypr_f=NA, eq_ssb_f=NA, eq_rec_f=NA, yield_f=NA)

# b)
  for(i in 1:length(f)){
    DF$phi_f[i] <- sum(survivorship_F(f=f[i],M=BI$M,n_ages=length(BI$sel),sel=BI$sel,message=F)*BI$waa*BI$mat)
    DF$ypr_f[i] <- sum(survivorship_F(f=f[i],M=BI$M,n_ages=length(BI$sel),sel=BI$sel,message=F)*BI$waa*
                      (1-exp(-(BI$M+f[i]*BI$sel)))*f[i]*BI$sel/(BI$M+f[i]*BI$sel))
  }  

DF$eq_ssb_f <- (BHa*DF$phi_f-1)/BHb # Equation 9
DF$eq_rec_f <- BHa*DF$eq_ssb_f/(1+BHb*DF$eq_ssb_f) # Substituting equilibrium SSB into the SRR (Equation 3)

# c)
DF$yield_f <- DF$ypr_f*DF$eq_rec_f # Yield is the product of YPR and number of recruits (equilibrium recruitment at the specified F)
# d)
Fmsy <- f[which(DF$yield_f == max(DF$yield_f))] # F that maximizes yield
Fmsy
# e)
SSBmsy <- DF$eq_ssb_f[which(DF$yield_f == max(DF$yield_f))] # Equilibrium SSB at Fmsy
SSBmsy
# f)
MSY <- DF$yield_f[which(DF$yield_f == max(DF$yield_f))] # Yield at Fmsy
MSY
```

The MSY reference points are plotted below the the yield curves:

```{r,figures-side, warning = F, fig.show="hold", out.width="75%"}

# Plot Yield vs. Equilibrium SSB with reference lines at SSBmsy and MSY
ggplot(DF) + geom_point(mapping=aes(y=yield_f,x=eq_ssb_f)) + theme_classic() + 
  labs(x="SSB (kt)",y="Yield (kt)") +
  scale_x_continuous(limits = c(0,40), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,3), expand = c(0, 0)) +
  geom_vline(xintercept=SSBmsy, linetype=2, color = "red") +
  geom_hline(yintercept=MSY, linetype=2, color = "red") 

# Plot Yield vs. F with reference lines at Fmsy and MSY
ggplot(DF) + geom_point(mapping=aes(y=yield_f,x=f)) + theme_classic() + 
  labs(x="F",y="Yield (kt)") +
  scale_x_continuous(limits = c(0,1.5), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,3), expand = c(0, 0)) +
  geom_vline(xintercept=Fmsy, linetype=2, color = "red") +
  geom_hline(yintercept=MSY, linetype=2, color = "red") 
```

## Note about Salmonids

The above calculations apply to iteroparous species, where we need to account for  mortality of mature fish as they age and spawn through the years. We do not have to account for this for semelparous species, such as Salmonids, which spawn only once in their lifetime. For these species, the population can be modeled using only the stock-recruit relationship,  often the Ricker (Ricker 1954) model. MSY-based reference points can be estimated directly from the alpha and beta parameters of the Ricker or Beverton-Holt stock-recruit models (see Hilborn and Walters 1992, Table 7.2). We do not have time to explore estimation of Salmonid reference points in these webinars but see **XXX** for more information. *RF has asked a colleague for some key refs*

## References

Hilborn R. and Walters, C.J. 1992. Quantitative fisheries stock assessment: choice, dynamics and uncertainty. Chapman and Hall, New York. 570 pp.

Ricker, W.E. 1954. Stock and Recruitment. Journal of the Fisheries Research Board of Canada 11(5), 559–623.

Walters, C.J. and Martell, S.J.D. 2004. Fisheries Ecology and Management. Princeton University Press, Princeton, 399 pp.
